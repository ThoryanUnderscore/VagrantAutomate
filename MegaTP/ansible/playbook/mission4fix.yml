---
- name: "Admin : Serveur Zabbix"
  hosts: localhost
  become: yes
  tasks:
    - name: Lancer Docker Zabbix
      community.docker.docker_compose:
        project_name: zabbix
        definition:
          version: '3.5'
          services:
            zabbix-db:
              image: mariadb:10.11
              environment: { MYSQL_DATABASE: zabbix, MYSQL_USER: zabbix, MYSQL_PASSWORD: password, MYSQL_ROOT_PASSWORD: root_password }
            zabbix-server:
              image: zabbix/zabbix-server-mysql:alpine-6.0-latest
              ports: ["10051:10051"]
              environment: { DB_SERVER_HOST: zabbix-db, MYSQL_USER: zabbix, MYSQL_PASSWORD: password }
            zabbix-web:
              image: zabbix/zabbix-web-apache-mysql:alpine-6.0-latest
              ports: ["8080:8080"]
              environment: { DB_SERVER_HOST: zabbix-db, MYSQL_USER: zabbix, MYSQL_PASSWORD: password, ZBX_SERVER_HOST: zabbix-server }

- name: "Nodes : Agents Linux"
  hosts: nodes
  become: yes
  tasks:
    - name: Install Repo et Agent
      dnf:
        name: ["https://repo.zabbix.com/zabbix/6.0/rhel/9/x86_64/zabbix-release-6.0-4.el9.noarch.rpm", "zabbix-agent"]
        state: present
        disable_gpg_check: yes

    - name: "Forcer la configuration (Ã©vite l'erreur Destination does not exist)"
      copy:
        dest: /etc/zabbix/zabbix_agentd.conf
        content: |
          Server=192.168.56.10
          ServerActive=192.168.56.10
          Hostname={{ inventory_hostname }}

    - name: Restart Agent
      service: { name: zabbix-agent, state: restarted, enabled: yes }