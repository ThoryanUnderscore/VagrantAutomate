# Fichier: ansible/playbooks/ha_cluster.yml
---
- name: "Installation et Configuration du Cluster HA"
  hosts: ha_cluster
  become: yes
  vars:
    hacluster_password: "ha_password_securise"
    vip_address: "192.168.56.20"

  tasks:
    # --- PRÉREQUIS & INSTALLATION ---
    - name: "Installer les paquets HA, Web et Samba"
      dnf:
        name: 
          - pacemaker
          - pcs
          - corosync
          - fence-agents-all
          - nginx
          - samba
        state: present

    - name: "Démarrer et activer le démon PCSD"
      service:
        name: pcsd
        state: started
        enabled: yes

    - name: "Définir le mot de passe de l'utilisateur hacluster"
      user:
        name: hacluster
        password: "{{ hacluster_password | password_hash('sha512') }}"

    # --- CONFIGURATION NGINX & SAMBA (Basique pour la démo) ---
    - name: "Créer une page Web par défaut pour identifier le noeud"
      copy:
        content: "<h1>Site HA hebergé sur {{ ansible_hostname }}</h1>"
        dest: /usr/share/nginx/html/index.html

    - name: "Configuration basique Samba"
      blockinfile:
        path: /etc/samba/smb.conf
        block: |
          [ha_share]
          path = /srv/samba/share
          read only = no
          guest ok = yes

    - name: "Créer le dossier partagé Samba"
      file:
        path: /srv/samba/share
        state: directory
        mode: '0777'

    # --- CRÉATION DU CLUSTER (Exécuté uniquement sur le premier nœud) ---
    - name: "Authentifier les noeuds du cluster"
      command: >
        pcs host auth node01.lab.local node02.lab.local 
        -u hacluster -p {{ hacluster_password }}
      run_once: true
      ignore_errors: yes # Ignore si déjà authentifié

    - name: "Créer et démarrer le cluster (Pacemaker/Corosync)"
      command: >
        pcs cluster setup ha_cluster --force node01.lab.local node02.lab.local
      run_once: true
      args:
        creates: /etc/corosync/corosync.conf

    - name: "Démarrer tous les noeuds du cluster"
      command: pcs cluster start --all
      run_once: true
      ignore_errors: yes

    - name: "Désactiver STONITH (car pas de périphérique de fencing physique dans ce lab)"
      command: pcs property set stonith-enabled=false
      run_once: true

    # --- RESSOURCES & CONTRAINTES [cite: 40, 41] ---
    - name: "Créer la Ressource VIP (IP Flottante)"
      command: >
        pcs resource create ClusterVIP ocf:heartbeat:IPaddr2 
        ip={{ vip_address }} cidr_netmask=24 op monitor interval=30s
      run_once: true
      ignore_errors: yes # Ignore si existe déjà

    - name: "Créer la Ressource Web (Nginx)"
      command: >
        pcs resource create WebServer systemd:nginx op monitor interval=10s
      run_once: true
      ignore_errors: yes

    - name: "Créer la Ressource Samba"
      command: >
        pcs resource create SambaServer systemd:smb op monitor interval=60s
      run_once: true
      ignore_errors: yes

    - name: "Créer le groupe de ressources (Colocation implicite: tout ensemble)"
      command: >
        pcs resource group add HA_Group ClusterVIP WebServer SambaServer
      run_once: true
      ignore_errors: yes